---
description: Динамическое добавление изображения NASA под тегом текста страницы с помощью сценариев содержимого
title: Создание учебника по расширению (часть 2)
author: MSEdgeTeam
ms.author: msedgedevrel
ms.date: 09/15/2020
ms.topic: article
ms.prod: microsoft-edge
keywords: Edge — Chromium, Web Development, HTML, CSS, JavaScript, разработчик, расширения
ms.openlocfilehash: 755b70635c93d7331ef3ac985625ba7ac5689679
ms.sourcegitcommit: 845a0d53a86bee3678f421adee26b3372cefce57
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/08/2020
ms.locfileid: "11104716"
---
# Создание учебника по расширению (часть 2)  
  
[Источник пакета расширения для этой части завершен][ArchiveExtensionGettingStartedPart2]    

## Обзор  

В этом руководстве рассматриваются следующие технологии расширения.
*   Добавление библиотек JavaScript в расширение  
*   Предоставление расширений ресурсов вкладкам браузера  
*   Включение страниц содержимого на существующие вкладки браузера  
*   Прослушивание сообщений на страницах с содержимым из всплывающих окон и ответа на них  

Вы узнаете, как обновить всплывающее меню, чтобы заменить статичный запуск изображения на заголовок и стандартную кнопку HTML.  Эта кнопка, если она выбрана, передает изображение звезды, внедренное в расширение, на страницу содержимого.  Это изображение будет вставлено на вкладку активного браузера. Чтобы получить дополнительные сведения, выполните указанные ниже действия.

1.  Удаление изображения из всплывающего окна и замена его на кнопку  

Сначала обновите `popup.html` файл с помощью перенаправленной текстовой разметки, в которой отображается заголовок и кнопка.  Эта кнопка вскоре будет программироваться, но теперь просто включите ссылку на пустой файл JavaScript `popup.js` .  Вот обновление HTML.  

```html
<html>
    <head>
        <meta charset="utf-8" />
        <style>
            body {
                width: 500px;
            }
            button {
                background-color: #336dab;
                border: none;
                color: white;
                padding: 15px 32px;
                text-align: center;
                font-size: 16px;
            }
        </style>
    </head>
    <body>
        <h1>Show the NASA picture of the day</h1>
        <h2>(select the image to remove)</h2>
        <button id="sendmessageid">Display</button>
        <script src="popup.js"></script>
    </body>
</html>
```  

После того как вы обновите и откроете расширение, появится всплывающее окно с кнопкой "Показать".  

:::image type="complex" source="./media/part2-popupdialog.png" alt-text="После нажатия значка расширения popup.html":::
   После нажатия значка расширения popup.html
:::image-end:::

<!--![popup.html display after pressing the Extension icon][ImagePart2Popupdialog]  -->  

2.  Стратегия обновления для отображения изображения в верхней части вкладки браузера  

После добавления кнопки Следующая задача — сделать так, чтобы она выместит `images/stars.jpeg` файл изображения в верхней части активной вкладки.  

Не забывайте, что каждая вкладка запускается в собственном потоке. Кроме того, расширение использует другой поток.  Сначала нужно создать сценарий содержимого, который будет добавлен на вкладку.  Затем отправьте сообщение со всплывающего окна на этот сценарий содержимого, запущенный на странице вкладки. Сценарий содержимого получает сообщение, которое описывает изображение, которое должно отображаться.  

3. Создание всплывающего сценария JavaScript для отправки сообщения  

Сначала нужно создать `popup/popup.js` и добавить код, чтобы отправить сообщение в несозданный сценарий содержимого, который вы должны создать и внедрить на вкладку браузера.  Для этого следующий код добавляет `onclick` событие в всплывающую кнопку отображения.  

```javascript
const sendMessageId = document.getElementById("sendmessageid");
if (sendMessageId) {
  sendMessageId.onclick = function() {
    // do something
  };
}
```  

В `onclick` событии найдите текущую вкладку браузера.  Затем используйте `chrome.tabs.sendmessage` API расширения для отправки сообщения на эту вкладку.  

В этом сообщении нужно добавить URL-адрес изображения, которое вы хотите отобразить. Кроме того, можно отправить уникальный код для назначения вставленному изображению.  Вы можете выбрать, чтобы JavaScript мог создавать содержимое, но для более поздних причин создать этот уникальный идентификатор здесь `popup.js` и передать его в сценарий содержимого, который еще не создан.  

В следующем фрагменте кода описан обновленный код в `popup/popup.js` .  Кроме того, передайте текущий идентификатор табуляции, который используется далее в этой статье.  

```javascript
const sendMessageId = document.getElementById("sendmessageid");
if (sendMessageId) {
    sendMessageId.onclick = function() {
        chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
            chrome.tabs.sendMessage(
                tabs[0].id,
                {
                    url: chrome.extension.getURL("images/stars.jpeg"),
                    imageDivId: `${guidGenerator()}`,
                    tabId: tabs[0].id
                },
                function(response) {
                    window.close();
                }
            );
            function guidGenerator() {
                const S4 = function () {
                    return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
                };
                return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
            }
        });
    };
}
```  

4. Создание звезд. JPEG, доступного на любой вкладке браузера  

Вы, скорее всего, захотите заинтересовать причины, по которым следует `images/stars.jpeg` использовать `chrome.extension.getURL` API расширения Chrome вместо того, чтобы просто передавать относительный URL-адрес без дополнительного префикса, как в предыдущем разделе.  Таким образом, этот дополнительный префикс, возвращаемый `getUrl` с подключенным изображением, выглядит примерно так, как показано ниже.  

```http
extension://inigobacliaghocjiapeaaoemkjifjhp/images/stars.jpeg
```  

Причина заключается в том, что вы вставляете изображение с помощью `src` атрибута `img` элемента на странице содержимого.  Страница содержимого выполняется в отдельном потоке, не совпадающем с потоком, на котором запущено расширение.  Для правильной работы вы должны предоставить статический файл изображения в качестве веб-актива.  

Добавьте в файл еще одну запись `manifest.json` , чтобы объявить, что изображение доступно для всех вкладок браузера.  Этот параметр является следующим: \ (вы должны увидеть его в полном `manifest.json` файле ниже, когда вы добавите объявление сценария содержимого, которое появится на странице \).  

```json
"web_accessible_resources": [
    "images/*.jpeg"
]
```  

Теперь вы написали код в `popup.js` файле для отправки сообщения на страницу содержимого, внедренную на текущую активную вкладку, но вы не создали и не добавите эту страницу содержимого.  Сделайте это прямо сейчас.  

5.  Обновление manifest.jsдля контента и веб-доступа  

Обновленный `manifest.json` , который включает в себя `content-scripts` и `web_accessible_resources` следующий.  

```json
{
    "name": "NASA picture of the day viewer",
    "version": "0.0.0.1",
    "manifest_version": 2,
    "description": "A Chromium extension to show the NASA picture of the day.",
    "icons": {
        "16": "icons/nasapod16x16.png",
        "32": "icons/nasapod32x32.png",
        "48": "icons/nasapod48x48.png",
        "128": "icons/nasapod128x128.png"
    },
    "browser_action": {
        "default_popup": "popup/popup.html"
    },
    "content_scripts": [
        {
            "matches": [
              "<all_urls>"
            ],
            "js": ["lib/jquery.min.js","content-scripts/content.js"]
        }
    ],
    "web_accessible_resources": [
        "images/*.jpeg"
    ]
}
```  

Добавленный раздел `content_scripts` .  `matches`Для этого атрибута задано значение `<all_urls>` , которое означает, что все файлы на `content_scripts` вкладках браузера будут добавлены при загрузке каждой вкладки.  Допустимые типы файлов, которые можно внедрить — это JavaScript и CSS.  Кроме того, вы добавите `libjquery.min.js` .  Вы можете включить эти возможности из скачивания, упомянутого в верхней части раздела.  

6. Добавление jQuery и понимание связанного потока  

В сценариях содержимого, которые вы добавляете, спланируйте использование jQuery \ ( `$` \).  Вы добавили версию minified для jQuery и помещаем ее в пакет расширения как `lib\jquery.min.js` .  Эти сценарии содержимого выполняются в отдельных изолированных средах, что означает, что jQuery, вставленный в `popup.js` страницу, не является общим для содержимого.  

Имейте в виду, что даже если на вкладке "браузер" запущен JavaScript на странице загруженной веб-страницы, доступ к содержимому не имеет.  Этот внедренный JavaScript просто имеет доступ к фактической загруженной модели DOM на вкладке "браузер".  

7. Добавление прослушивателя сообщений сценария содержимого  

Здесь показано, что `content-scripts\content.js` файл, который добавляется в каждую вкладку браузера на основе вашего `manifest.json` `content-scripts` раздела.  

```javascript
chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
    $("body").prepend(
        `<img  src="${request.url}" id="${request.imageDivId}"
               class="slide-image" /> `
    );
    $("head").prepend(
        `<style>
          .slide-image {
              height: auto;
              width: 100vw;
          }
        </style>`
    );
    $(`#${request.imageDivId}`).click(function() {
        $(`#${request.imageDivId}`).remove(`#${request.imageDivId}`);
    });
    sendResponse({ fromcontent: "This message is from content.js" });
});
```  

Обратите внимание, что все указанные выше сценарии JavaScript — это регистрация `listener` с помощью `chrome.runtime.onMessage.addListener` метода API расширения.  Этот прослушиватель ждет сообщения, которые вы отправили ранее из `popup.js` описанных выше `chrome.tabs.sendMessage` методов расширения API.  

Первый параметр `addListener` метода — это функция, первый параметр которой — Request, — сведения о переданном сообщении.  Не забывайте, что `popup.js` при использовании `sendMessage` метода эти атрибуты первого параметра — `url` и `imageDivId` .  

Если событие обрабатывается прослушивателем, выполняется функция, которая является первым параметром.  Первый параметр этой функции — объект, которому назначены атрибуты `sendMessage` .  Эта функция просто обрабатывает три строки сценария jQuery.  

*   Первая строка сценария динамически вставляется в заголовок DOM в **\<style\>** раздел, который необходимо назначить `slide-image` `img` элементу как класс.  
*   Вторая строка сценария добавляет `img` элемент прямо под `body` вкладкой браузера, которому назначен класс, а также `slide-image` `imageDivId` как идентификатор этого элемента изображения.  
*   Третья строка сценария добавляет `click` событие, которое охватывает все изображение, позволяя пользователю выбрать любое место на изображении, и это изображение удаляется из страницы \ (вместе с прослушивателем событий \).  

8. Добавление функции для удаления отображаемого изображения при выделении  

Теперь при переходе на любую страницу и выборе значка **расширения** всплывающее меню отображается следующим образом.  

:::image type="complex" source="./media/part2-popupdialog.png" alt-text="После нажатия значка расширения popup.html":::
   После нажатия значка расширения popup.html
:::image-end:::

<!--![popup.html display after pressing the Extension icon][ImagePart2Popupdialog]  -->  

После `Display` нажатия кнопки вы получите более ранний вариант.  Если вы выберете в любом месте `stars.jpeg` изображения, то этот элемент изображения удаляется, а страницы вкладок — на то, что было первоначально отображено.  

:::image type="complex" source="./media/part2-showingimage.png" alt-text="После нажатия значка расширения popup.html"  
